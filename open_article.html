<!DOCTYPE html>
<html lang="en">
	<head>
		<title>Floris Ng - Article</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<link rel="stylesheet" type="text/css" href="style.css" media="screen">
		<link rel="shortcut icon" type="image/x-icon" href="img/pp.jpg" />
	</head>
	<body>
		<div id="header">
			<div class="pp">
				<img src="img/pp.png" class="pic">
			</div>
			<div class="big_menu">
				<nav>
					<div class="dropdown">
						<img src="img/home_icon.jpg" class="icon">
						<button class="dropbtn">HOME<img src="img/list.png" class="very_small push_left"></button>
						<div class="dropdown-content">
						  <a href="index.html#skills" title="Skills">SKILLS</a>
						  <a href="index.html#exp" title="Projects">PROJECTS</a>
						  <a href="index.html#contacts" title="Contacts">CONTACTS</a>
						</div>
					</div>
					<script>
						document.write("<div title='Articles'><a href='articles.html' class='other_link'><img src='img/article_icon.png' class='icon'>ARTICLES</a></div>");
						if(sessionStorage.getItem("status") === "connected") {
							document.write("<div title='My profil'><a href='profil.html' class='other_link'><img src='img/user_profil.png' class='userPro profil_pic'></a></div>");
						}
						else{
							document.write("<div title='Sign Up'><a href='signup.html' class='other_link'><img src='img/signup.png' class='icon'>Create an account</a></div>");
							document.write("<div title='Sign In'><a href='signin.html' class='signin'>SIGN IN</a></div>");
						}
					</script>
				</nav>
			</div>
			<div class="open_close_space">
				<img src="img/open_menu_icon.png" class="open_menu_icon open_close" onclick="open_menu()">
				<img src="img/close_menu_icon.png" class="close_menu_icon open_close" onclick="close_menu()">
			</div>
		</div>
		<div class="small_menu">
			<nav>
				<a class="home" onclick="open_show()">
					<img src="img/home_icon.jpg" class="icon">
					HOME
					<img src="img/up.png" class="up very_small right">
					<img src="img/down.png" class="down very_small right">
				</a>
				<div class="show">
					<a href="index.html#skills">
						<img src="img/skill.png" class="icon">
						SKILLS
					</a>
					<a href="index.html#exp">
						<img src="img/pro.png" class="icon">
						PROJECTS
					</a>
					<a href="index.html#contacts">
						<img src="img/contacts.png" class="icon">
						CONTACT
					</a>
				</div>
				<script>
					document.write("<a href='articles.html'><img src='img/article_icon.png' class='icon'>ARTICLES</a>");
					if(sessionStorage.getItem("status") === "connected") {
						document.write("<a href='profil.html'><img src='img/user_profil.png' class='icon'>Profil</a>");
						document.write("<a href='logout.html'><img src='img/logout.png' class='icon'>Logout</a>");
					}
					else{
						document.write("<a href='signup.html'><img src='img/signup.png' class='icon'>Create an account</a>");
						document.write("<a href='signin.html'>SIGN IN</a>");
					}
				</script>
			</nav>
		</div>
		<div class="articles">
			<div class="list_of_articles"></div>
			<script>
				if(sessionStorage.getItem("status") === "connected") {
	document.write("<input id='comment' type='text' placeholder='Your comment here ...'><button onclick='comment()' class='btn push_left'>Post</button>");
				}
				else{
					document.write("Get connected to comment ");
					document.write("<a href='signin.html' class='btn'>Sign In</a>");
				}
			</script>
			<div id="nbr_comments"></div>
			<div class="list_of_comments"></div>
		</div>
		<footer>
			<div class="query" onclick="open_query_form()">
				Help<hr class="query_hr">
				Ask a question
			</div>
			<div class="query_form">
				<p>
					<span class="sous_titre">How can I help?</span>
				</p>
				<form action="contact.html">
						<input type="text" placeholder="Full name" required>
						<br>
						<input type="text" placeholder="Company" required>
						<br>
						<input type="tel" placeholder="Phone number" required>
						<br>
						<input type="email" placeholder="E-mail" required>
						<br>
						<input type="text" class="large_field" placeholder="Question here ..." required>
						<p>
							<input type="submit" value="SEND" class="reverse_btn">
							<span class="reverse_link right" onclick="close_query_form()">Close</span>
						</p>
				</form>
			</div>
			<div class="center">
				<img src="img/copyright.jpg" class="copyright"> Floris Ng 2020
			</div>
		</footer>
		<script src="https://www.gstatic.com/firebasejs/7.17.1/firebase-app.js"></script>
		<script src="https://www.gstatic.com/firebasejs/7.6.1/firebase-database.js"></script>
		<script src="https://www.gstatic.com/firebasejs/7.17.1/firebase-analytics.js"></script>
		<script>
			// Your web app's Firebase configuration
			var firebaseConfig = {
				apiKey: "AIzaSyDzNGaESF4A8DbMKZyg1WuvmBB62x5_-To",
				authDomain: "floris-ng.firebaseapp.com",
				databaseURL: "https://floris-ng.firebaseio.com",
				projectId: "floris-ng",
				storageBucket: "floris-ng.appspot.com",
				messagingSenderId: "667336396068",
				appId: "1:667336396068:web:8398065c7ae3d8ab50f7b1",
				measurementId: "G-G1MQMC21Y7"
			};
			// Initialize Firebase
			firebase.initializeApp(firebaseConfig);
			firebase.analytics();
			
				// Get ID from URL GET
				const queryString = window.location.search;
				const urlParams = new URLSearchParams(queryString);
				const id = urlParams.get('id');

				// Retrieve user information
				let ref = firebase.database().ref("articles");
				ref.on("value", function gotData(data) {
					let d = data.val();
					let keys = Object.keys(d);
					let i = 0;
					let found = false;
					while(i < keys.length && found === false) {
						let k = keys[i];
						let saved_id = k;
						if(saved_id == id) {
							found = true;
							let saved_title = d[k].title;
							let saved_likes = d[k].likes;
							let saved_content = d[k].content;
							let saved_date = d[k].date;
							let saved_comments = d[k].comments;
							$(".list_of_articles").append("<p><span class='title'>" + saved_title + "</p>");
							$(".list_of_articles").append("<p>" + saved_content + "</p>");
							$(".list_of_articles").append("<p>");
							$(".list_of_articles").append("<img src='img/like.png' class='icon cursor_pointer' onclick='like(" + saved_id + ")'>" + saved_likes);
							$(".list_of_articles").append("<img src='img/comment.jpg' class='icon push_left'>" + saved_comments);
							$(".list_of_articles").append("</p>");
						}
						i++;
					}
				});

				// Get ID from URL GET
				const qs = window.location.search;
				const up = new URLSearchParams(qs);
				const id_of_the_srticle = up.get('id');

				
				document.querySelector("#nbr_comments").innerHTML = "<h2>Comments</h2>";
				// Retrieve user information
				let articles_ref = firebase.database().ref("comments");
				articles_ref.on("value", function gotData(data) {
					let d = data.val();
					let keys = Object.keys(d);
					let i = 0;
					while(i < keys.length) {
						let k = keys[i];
						let id_article = d[k].id_article;
						if(id_article == id) {
							$(".list_of_comments").append("<p>");
							$(".list_of_comments").append("<img src='img/checked.png' class='icon push_right'><b>" + d[k].firstname + " " + d[k].lastname +" </b>: ");
							$(".list_of_comments").append(d[k].comment + " - <b>" + d[k].date + "</b>");
							$(".list_of_comments").append("</p>");
							$(".list_of_comments").append("<hr>");
						}
						i++;
					}
				});

				// Like an article
			function like (id) {
						// Retrieve user information
						let like_nbr = 0;
						let content = 0;
						let date = 0;
						let comments = "";
						let ref = firebase.database().ref("articles");
						ref.on("value", function gotData(data) {
							let d = data.val();
							let keys = Object.keys(d);
							let i = 0;
							let found = false;
							while(i < keys.length && found === false) {
								let k = keys[i];
								let saved_id = k;
								if(saved_id == id) {
									found = true;
									comments = d[k].comments;
									content = d[k].content;
									date = d[k].date;
									like_nbr = d[k].likes + 1;
									title = d[k].title;
								}
								i++;
							}
						});

						let data = {
							comments: comments,
							content: content,
							date: date,
							likes: like_nbr,
							title: title
						}
						firebase.database().ref('articles/' + id).set(data);
						window.location = "";
				}

				// Save a comment
				function comment () {
					// Get ID from URL GET
					const queryString = window.location.search;
					const urlParams = new URLSearchParams(queryString);
					const id = urlParams.get('id');

											let ref = firebase.database().ref("comments");
                                            let data = {
												id_article: id,
												firstname: sessionStorage.getItem("firstname"),
												lastname: sessionStorage.getItem("lastname"),
												date: daterEn(),
												comment: document.querySelector("#comment").value
                                            }
											ref.push(data);

						// Retrieve user information
						let like_nbr = 0;
						let content = 0;
						let date = 0;
						let comments = "";
						let new_ref = firebase.database().ref("articles");
						new_ref.on("value", function gotData(data) {
							let d = data.val();
							let keys = Object.keys(d);
							let i = 0;
							let found = false;
							while(i < keys.length && found === false) {
								let k = keys[i];
								let saved_id = k;
								if(saved_id == id) {
									found = true;
									comments = d[k].comments + 1;
									content = d[k].content;
									date = d[k].date;
									like_nbr = d[k].likes;
									title = d[k].title;
								}
								i++;
							}
						});

						let new_data = {
							comments: comments,
							content: content,
							date: date,
							likes: like_nbr,
							title: title
						}
						firebase.database().ref('articles/' + id).set(new_data);

						window.location = "";
				}
		</script>
		<script type="text/javascript" src="js.js"></script>
		<script type="text/javascript" src="http://code.jquery.com/jquery-1.7.1.min.js"></script>
    </body>
</html>